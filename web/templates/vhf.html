<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VHF/SDR Control - Tactical Dashboard</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
</head>
<body data-page="vhf">
    {% if demo_mode %}
    <div class="demo-mode">‚ö† DEMO MODE - No Cluster Connected</div>
    {% endif %}
    <!-- Collapsible Quick Nav Sidebar -->
    {% include 'components/sidebar.html' %}
    <div id="content">
        <!-- page-specific content -->
    </div>
<!--Header Embed Container-->
<nav class="navbar" id="main-navbar">
        <div id="header-container"></div>
</nav>
    <main class="container">
        <section class="panel">
            <h2>üìª VHF/SDR FREQUENCY CONTROL</h2>
            <p style="color: #AAA; margin: 0;">SDR Spectrum Monitoring & RF Transciever Tools</p>
        </section>
        <div class="sdr-container">
            <!-- Frequency Control Panel -->
            <div class="frequency-panel">
                <h3 style="margin: 0 0 15px 0; color: #2196F3;">RECEIVER CONTROL</h3>
                <!-- Frequency Display -->
                <div class="frequency-display">
                    <div class="frequency-value" id="frequencyDisplay">146.520</div>
                    <div class="frequency-unit">MHz</div>
                </div>
                <!-- Quick Frequency Input -->
                <div class="control-group">
                    <label class="control-label">Set Frequency</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" class="frequency-input" id="frequencyInput" value="146.520" 
                               placeholder="Enter frequency" style="flex: 1;">
                        <button class="btn btn-primary" onclick="setFrequency()" style="padding: 10px 20px;">
                            SET
                        </button>
                    </div>
                </div>
                <!-- Frequency Adjustment Buttons -->
                <div class="control-group">
                    <label class="control-label">Fine Tune</label>
                    <div class="frequency-buttons">
                        <button class="freq-btn" onclick="adjustFrequency(-1)">-1 MHz</button>
                        <button class="freq-btn" onclick="adjustFrequency(-0.1)">-0.1 MHz</button>
                        <button class="freq-btn" onclick="adjustFrequency(0.1)">+0.1 MHz</button>
                        <button class="freq-btn" onclick="adjustFrequency(-0.01)">-10 kHz</button>
                        <button class="freq-btn" onclick="adjustFrequency(0.01)">+10 kHz</button>
                        <button class="freq-btn" onclick="adjustFrequency(1)">+1 MHz</button>
                    </div>
                </div>
                <!-- Mode Selection -->
                <div class="control-group">
                    <label class="control-label">Modulation</label>
                    <div class="mode-selector">
                        <button class="mode-btn active" onclick="setMode(this, 'FM')">FM</button>
                        <button class="mode-btn" onclick="setMode(this, 'AM')">AM</button>
                        <button class="mode-btn" onclick="setMode(this, 'SSB')">SSB</button>
                        <button class="mode-btn" onclick="setMode(this, 'CW')">CW</button>
                    </div>
                </div>
                <!-- Presets -->
                <div class="control-group">
                    <label class="control-label">Saved Frequencies</label>
                    <div class="preset-buttons">
                        <button class="preset-btn" onclick="loadFrequency(146.52)">2M Simplex</button>
                        <button class="preset-btn" onclick="loadFrequency(462.5625)">GMRS 462</button>
                        <button class="preset-btn" onclick="loadFrequency(144.2)">2M Beacon</button>
                        <button class="preset-btn" onclick="loadFrequency(121.5)">Emergency</button>
                    </div>
                </div>
                <!-- Recording Section -->
                <div class="recording-panel">
                    <h4 style="margin: 0 0 10px 0; color: #FF8800;">üéôÔ∏è RECORDING</h4>
                    <button class="recording-btn" id="recordBtn" onclick="toggleRecording()">
                        ‚óè REC
                    </button>
                    <div style="color: #AAA; font-size: 11px; margin-top: 10px; text-align: center;">
                        Duration: <span id="recordDuration" style="color: #FF8800;">--:--</span>
                    </div>
                </div>
            </div>
            <!-- Spectrum Display -->
            <div>
                <!-- Signal Strength Meter -->
                <div class="spectrum-display">
                    <h3 style="margin: 0 0 15px 0; color: #2196F3;">SIGNAL ANALYSIS</h3>
                    
                    <div class="signal-meter">
                        <div class="meter-label">S-Meter (Signal Strength)</div>
                        <div class="meter-bar">
                            <div class="meter-fill" id="sMeter" style="width: 65%;">S 8</div>
                        </div>
                    </div>
                    <!-- Spectrum Canvas -->
                    <div class="meter-label">Frequency Spectrum</div>
                    <canvas id="spectrumCanvas" class="spectrum-canvas"></canvas>
                    <!-- Signal Stats -->
                    <table class="info-table">
                        <tr>
                            <td>Signal Strength</td>
                            <td id="signalStrength">-65 dBm</td>
                        </tr>
                        <tr>
                            <td>Noise Level</td>
                            <td id="noiseLevel">-90 dBm</td>
                        </tr>
                        <tr>
                            <td>SNR</td>
                            <td id="snr">25 dB</td>
                        </tr>
                        <tr>
                            <td>Modulation</td>
                            <td id="modulation">FM</td>
                        </tr>
                        <tr>
                            <td>Bandwidth</td>
                            <td id="bandwidth">12.5 kHz</td>
                        </tr>
                    </table>
                </div>
                <!-- Receiver Info -->
                <div class="spectrum-display">
                    <h3 style="margin: 0 0 15px 0; color: #2196F3;">RECEIVER STATUS</h3>
                    <table class="info-table">
                        <tr>
                            <td>Device</td>
                            <td>RTL-SDR (Generic)</td>
                        </tr>
                        <tr>
                            <td>Tuner</td>
                            <td>Rafael Micro R820T</td>
                        </tr>
                        <tr>
                            <td>Gain</td>
                            <td id="gainValue">37 dB</td>
                        </tr>
                        <tr>
                            <td>Sample Rate</td>
                            <td>2.048 MSPS</td>
                        </tr>
                        <tr>
                            <td>Status</td>
                            <td style="color: #00FF00;">‚óè ACTIVE</td>
                        </tr>
                    </table>
                    <!-- Gain Control -->
                    <div style="margin-top: 20px;">
                        <label class="control-label">Gain Control</label>
                        <input type="range" min="0" max="50" value="37" id="gainControl" 
                               style="width: 100%; cursor: pointer;" onchange="adjustGain(this.value)">
                        <div style="color: #AAA; font-size: 11px; margin-top: 5px; text-align: center;">
                            <span id="gainDisplay">37 dB</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <section class="panel">
    <h2>üì° RF PROPAGATION ESTIMATION</h2>
    <p style="color:#AAA; margin:0;">
        Coverage visualization (demo model ‚Äì geometry + environmental degradation)
    </p>

    <div style="display:flex; gap:12px; flex-wrap:wrap; margin-top:12px;">
        <label>
            Frequency (MHz)
            <input type="number" id="propFreq" value="146.52" step="0.01">
        </label>
        <label>
            ERP (W)
            <input type="number" id="propPower" value="5">
        </label>
        <label>
            Antenna Height (m)
            <input type="number" id="propHeight" value="10">
        </label>
        <label>
            Environment
            <select id="propEnv">
                <option value="urban">Urban</option>
                <option value="suburban">Suburban</option>
                <option value="rural">Rural</option>
            </select>
        </label>
        <button class="btn btn-primary" onclick="updatePropagation()">Recalculate</button>
    </div>

    <div id="propagationMap"
         style="width:100%; height:420px; margin-top:15px; border:1px solid #333;">
    </div>
</section>

    </main>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let propMap;
let txMarker;
let idealCoverage;
let degradedCoverage;

function initPropagationMap() {
    propMap = L.map('propagationMap').setView([39.5, -98.35], 5);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
    }).addTo(propMap);

    txMarker = L.marker(propMap.getCenter())
        .addTo(propMap)
        .bindPopup('Transmitter Location');

    updatePropagation();
}

document.addEventListener('DOMContentLoaded', initPropagationMap);
</script>
<script>
function updatePropagation() {
    if (!propMap || !txMarker) return;

    const freq   = parseFloat(document.getElementById('propFreq').value);
    const power  = parseFloat(document.getElementById('propPower').value);
    const height = parseFloat(document.getElementById('propHeight').value);
    const env    = document.getElementById('propEnv').value;

    if (idealCoverage) propMap.removeLayer(idealCoverage);
    if (degradedCoverage) propMap.removeLayer(degradedCoverage);

    const center = txMarker.getLatLng();

    // ---- DEMO RF SCALING (plausible + explainable) ----
    const freqFactor   = Math.sqrt(150 / freq);
    const powerFactor  = Math.sqrt(power);
    const heightFactor = Math.sqrt(height / 10);

    const envLoss = {
        urban: 0.45,
        suburban: 0.65,
        rural: 0.85
    }[env];

    const baseRangeKm =
        15 * freqFactor * powerFactor * heightFactor * envLoss;

    const majorKm = baseRangeKm * 1.3;
    const minorKm = baseRangeKm * 0.8;
    const tiltDeg = Math.random() * 30 - 15;
    const tiltRad = tiltDeg * Math.PI / 180;

    // ---- IDEAL ELLIPSE (polygon approximation) ----
    const ellipsePoints = [];
    const steps = 72;

    for (let i = 0; i < steps; i++) {
        const theta = (i / steps) * 2 * Math.PI;

        const x = majorKm * Math.cos(theta);
        const y = minorKm * Math.sin(theta);

        const xr = x * Math.cos(tiltRad) - y * Math.sin(tiltRad);
        const yr = x * Math.sin(tiltRad) + y * Math.cos(tiltRad);

        const latOffset = yr / 111;
        const lngOffset = xr / (111 * Math.cos(center.lat * Math.PI / 180));

        ellipsePoints.push([
            center.lat + latOffset,
            center.lng + lngOffset
        ]);
    }

    idealCoverage = L.polygon(ellipsePoints, {
        color: '#00ff00',
        fillColor: '#00ff00',
        fillOpacity: 0.25,
        weight: 2
    }).addTo(propMap);

    // ---- DEGRADED ENVIRONMENT BLOB ----
    const blobPoints = [];

    for (let i = 0; i < steps; i++) {
        const theta = (i / steps) * 2 * Math.PI;

        const distortion =
            env === 'urban'
                ? 0.5 + Math.random() * 0.7
                : 0.7 + Math.random() * 0.4;

        const x = majorKm * Math.cos(theta) * distortion;
        const y = minorKm * Math.sin(theta) * distortion;

        const xr = x * Math.cos(tiltRad) - y * Math.sin(tiltRad);
        const yr = x * Math.sin(tiltRad) + y * Math.cos(tiltRad);

        const latOffset = yr / 111;
        const lngOffset = xr / (111 * Math.cos(center.lat * Math.PI / 180));

        blobPoints.push([
            center.lat + latOffset,
            center.lng + lngOffset
        ]);
    }

    degradedCoverage = L.polygon(blobPoints, {
        color: '#00ff00',
        fillColor: '#00ff00',
        fillOpacity: 0.15,
        weight: 1,
        dashArray: '6,6'
    }).addTo(propMap);

    idealCoverage.bindPopup(
        `Ideal Coverage<br>
         Major Axis: ${majorKm.toFixed(1)} km<br>
         Minor Axis: ${minorKm.toFixed(1)} km`
    );

    degradedCoverage.bindPopup(
        `Environment-Degraded Coverage`
    );
}
</script>

    <script>
        let currentFrequency = 146.52;
        let currentMode = 'FM';
        let isRecording = false;
        let recordStartTime = null;
        let recordInterval = null;
        function setFrequency() {
            const input = document.getElementById('frequencyInput');
            const freq = parseFloat(input.value);
            if (isNaN(freq) || freq < 1 || freq > 6000) {
                alert('Invalid frequency. Must be between 1 and 6000 MHz');
                return;
            }
            currentFrequency = freq;
            updateFrequencyDisplay();
        }
        function loadFrequency(freq) {
            currentFrequency = freq;
            document.getElementById('frequencyInput').value = freq;
            updateFrequencyDisplay();
        }
        function adjustFrequency(delta) {
            currentFrequency += delta;
            if (currentFrequency < 1) currentFrequency = 1;
            if (currentFrequency > 6000) currentFrequency = 6000;
            document.getElementById('frequencyInput').value = currentFrequency.toFixed(3);
            updateFrequencyDisplay();
        }
        function updateFrequencyDisplay() {
            document.getElementById('frequencyDisplay').textContent = currentFrequency.toFixed(3);
            // Simulate frequency change effect
            const meter = document.getElementById('sMeter');
            const strength = 50 + Math.random() * 30;
            meter.style.width = strength + '%';
            meter.textContent = 'S ' + Math.round(strength / 10);
        }
        function setMode(button, mode) {
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            currentMode = mode;
            document.getElementById('modulation').textContent = mode;
        }
        function adjustGain(value) {
            document.getElementById('gainValue').textContent = value + ' dB';
            document.getElementById('gainDisplay').textContent = value + ' dB';
            // Update S-meter with gain adjustment
            const meter = document.getElementById('sMeter');
            const strength = Math.min(100, 30 + (value - 20) * 0.8);
            meter.style.width = strength + '%';
        }
        function toggleRecording() {
            isRecording = !isRecording;
            const btn = document.getElementById('recordBtn');
            const durationSpan = document.getElementById('recordDuration');
            if (isRecording) {
                btn.classList.add('active');
                btn.textContent = '‚èπ STOP REC';
                recordStartTime = Date.now();
                recordInterval = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - recordStartTime) / 1000);
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    durationSpan.textContent = 
                        String(minutes).padStart(2, '0') + ':' + 
                        String(seconds).padStart(2, '0');
                }, 100);
            } else {
                btn.classList.remove('active');
                btn.textContent = '‚óè REC';
                clearInterval(recordInterval);
                const elapsed = Math.floor((Date.now() - recordStartTime) / 1000);
                alert(`üìÅ Recording saved (${elapsed} seconds)`);
                durationSpan.textContent = '--:--';
            }
        }
        function drawSpectrum() {
            const canvas = document.getElementById('spectrumCanvas');
            const ctx = canvas.getContext('2d');
            // Clear canvas
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            // Draw frequency axis
            ctx.strokeStyle = 'rgba(33, 150, 243, 0.3)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 10; i++) {
                const x = (canvas.width / 10) * i;
                ctx.beginPath();
                ctx.moveTo(x, canvas.height - 30);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
                ctx.fillStyle = '#2196F3';
                ctx.font = '10px Courier New';
                ctx.textAlign = 'center';
                ctx.fillText((currentFrequency - 5 + i) + ' MHz', x, canvas.height - 5);
            }
            // Draw spectrum data
            ctx.strokeStyle = '#00FF00';
            ctx.lineWidth = 2;
            ctx.beginPath();
            for (let x = 0; x < canvas.width; x += 2) {
                const progress = x / canvas.width;
                const noise = Math.sin(progress * Math.PI * 2) * 20 + 40;
                const signal = progress > 0.4 && progress < 0.6 ? 80 : 0;
                const y = canvas.height - 30 - (noise + signal) / 100 * (canvas.height - 30);
                if (x === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();
            // Draw baseline
            ctx.strokeStyle = 'rgba(33, 150, 243, 0.2)';
            ctx.beginPath();
            ctx.moveTo(0, canvas.height - 30);
            ctx.lineTo(canvas.width, canvas.height - 30);
            ctx.stroke();
        }
        // Initialize
        function init() {
            updateFrequencyDisplay();
            drawSpectrum();
            // Redraw spectrum periodically
            setInterval(drawSpectrum, 100);
        }
        init();
    </script>
<script>
const modal = document.getElementById('node-modal');
const modalNodeName = document.getElementById('modal-node-name');
let currentNode = '';
function openNodeModal(nodeName){
  currentNode = nodeName;
  modalNodeName.textContent = nodeName + " Node Actions";
  modal.style.display = "block";
}
function closeNodeModal(){
  modal.style.display = "none";
}
function rebootNode(){
  alert(currentNode + " node reboot triggered!");
}
function runDiagnostics(){
  alert("Running diagnostics on " + currentNode + " node.");
}
window.onclick = function(event){
  if(event.target == modal){ closeNodeModal(); }
}
// Toggle alerts
document.querySelectorAll('.alert-icon').forEach(icon => {
  icon.addEventListener('click', e => {
    e.preventDefault();
    icon.parentElement.querySelector('.alert-panel').classList.toggle('visible');
  });
});
</script>
<script>
(() => {
    const mapGuard = document.querySelector('.map-guard');
    const overlay  = document.querySelector('.map-overlay');
    if (!mapGuard || !overlay) return;
    let blockTimer = null;
    mapGuard.addEventListener('mouseenter', () => {
        overlay.classList.add('active');
        blockTimer = setTimeout(() => {
            overlay.classList.remove('active');
            blockTimer = null;
        }, 900);
    });
    mapGuard.addEventListener('mouseleave', () => {
        overlay.classList.remove('active');
        if (blockTimer) {
            clearTimeout(blockTimer);
            blockTimer = null;
        }
    });
})();
</script>
</body>
</html>
