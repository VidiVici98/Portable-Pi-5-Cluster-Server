<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preconnect" href="https://rawcdn.githack.com" crossorigin>
    <link rel="preconnect" href="https://basemaps.cartocdn.com" crossorigin>
    <title>Airspace / RF Monitoring - Tactical Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
</head>
<body data-page="sigint">
    {% if demo_mode %}
    <navbar class="demo-mode">‚ö† DEMO MODE - No Cluster Connected</navbar>
    {% endif %}
    <!-- Collapsible Quick Nav Sidebar -->
    {% include 'components/sidebar.html' %}
    <div id="content">
        <!-- page-specific content -->
    </div>
<!--Header Embed Container-->
<nav class="navbar" id="main-navbar">
        <div id="header-container"></div>
</nav>
    <main class="container">
        <section class="panel" id="adsb-section">
            <h2>üì° ADSB/UAT AIRCRAFT TRACKING</h2>
            <p style="color: #AAA; margin: 0;">Airspace Monitoring Tools</p>
        </section>
        <!-- Statistics Panel -->
        <div class="stats-panel">
            <div class="stat-card">
                <div class="stat-label">Aircraft Tracked</div>
                <div class="stat-value" id="aircraftCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Messages/sec</div>
                <div class="stat-value" id="messageRate">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Max Altitude</div>
                <div class="stat-value" id="maxAltitude">0 ft</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg Speed</div>
                <div class="stat-value" id="avgSpeed">0 kts</div>
            </div>
        </div>
        <!-- Map -->
        <div class="card" id="map-section">
            <h2>LIVE AIRCRAFT MAP</h2>
            <div class="map-card">
                <div class="map-guard">
                    <div id="map"></div>
                    <div class="map-overlay" aria-hidden="true"></div>
                </div>
                    <!-- Controls -->
        <div class="controls">
            <h3 style="margin: 0 0 15px 0; color: #00FF00;">‚öôÔ∏è TRACKING CONTROLS</h3>
            <div class="control-group">
                <label>Filter by Type:</label>
                <select id="typeFilter">
                    <option value="">All Aircraft</option>
                    <option value="commercial">Commercial</option>
                    <option value="military">Military</option>
                    <option value="general">General Aviation</option>
                    <option value="cargo">Cargo</option>
                </select>
            </div>
            <div class="control-group">
                <label>Min Altitude (ft):</label>
                <input type="number" id="minAltitude" value="0" min="0" step="1000">
            </div>
            <div class="control-group">
                <label>Auto-Refresh (sec):</label>
                <input type="number" id="refreshInterval" value="5" min="1" max="60" step="1">
            </div>
            <button class="btn btn-primary" style="width: 100%; margin-top: 10px;" onclick="toggleTracking()">
                ‚ñ∂ Start Tracking
            </button>
            </div>
            </div>
        </div>
        <!-- Aircraft List -->
        <div class="adsb-container" id="aircraft-section">
            <div class="aircraft-details">
                <h3>Aircraft Details</h3>
                <div id="selectedAircraft" style="color: #AAA; text-align: center; padding: 20px;">
                    Select aircraft on map or from list
                </div>
            </div>
            <div class="aircraft-list">
                <h4 style="margin: 0 0 10px 0; color: #00FF00; text-transform: uppercase; font-size: 11px;">
                    Tracked Aircraft
                </h4>
                <div id="aircraftListContainer">
                    <div style="color: #AAA; text-align: center; padding: 20px;">
                        Loading aircraft...
                    </div>
                </div>
            </div>
        </div>
        <section class="panel">
            <h2>üìª VHF/SDR FREQUENCY CONTROL</h2>
            <p style="color: #AAA; margin: 0;">SDR Spectrum Monitoring & RF Transciever Tools</p>
        </section>
        <div class="sdr-container" id="reciever-control">
            <!-- Frequency Control Panel -->
            <div class="frequency-panel">
                <h3 style="margin: 0 0 15px 0; color: #2196F3;">RECEIVER CONTROL</h3>
                <!-- Frequency Display -->
                <div class="frequency-display">
                    <div class="frequency-value" id="frequencyDisplay">146.520</div>
                    <div class="frequency-unit">MHz</div>
                </div>
                <!-- Quick Frequency Input -->
                <div class="control-group">
                    <label class="control-label">Set Frequency</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" class="frequency-input" id="frequencyInput" value="146.520" 
                               placeholder="Enter frequency" style="flex: 1;">
                        <button class="btn btn-primary" onclick="setFrequency()" style="padding: 10px 20px;">
                            SET
                        </button>
                    </div>
                </div>
                <!-- Frequency Adjustment Buttons -->
                <div class="control-group">
                    <label class="control-label">Fine Tune</label>
                    <div class="frequency-buttons">
                        <button class="freq-btn" onclick="adjustFrequency(-1)">-1 MHz</button>
                        <button class="freq-btn" onclick="adjustFrequency(-0.1)">-0.1 MHz</button>
                        <button class="freq-btn" onclick="adjustFrequency(0.1)">+0.1 MHz</button>
                        <button class="freq-btn" onclick="adjustFrequency(-0.01)">-10 kHz</button>
                        <button class="freq-btn" onclick="adjustFrequency(0.01)">+10 kHz</button>
                        <button class="freq-btn" onclick="adjustFrequency(1)">+1 MHz</button>
                    </div>
                </div>
                <!-- Mode Selection -->
                <div class="control-group">
                    <label class="control-label">Modulation</label>
                    <div class="mode-selector">
                        <button class="mode-btn active" onclick="setMode(this, 'FM')">FM</button>
                        <button class="mode-btn" onclick="setMode(this, 'AM')">AM</button>
                        <button class="mode-btn" onclick="setMode(this, 'SSB')">SSB</button>
                        <button class="mode-btn" onclick="setMode(this, 'CW')">CW</button>
                    </div>
                </div>
                <!-- Presets -->
                <div class="control-group">
                    <label class="control-label">Saved Frequencies</label>
                    <div class="preset-buttons">
                        <button class="preset-btn" onclick="loadFrequency(146.52)">2M Simplex</button>
                        <button class="preset-btn" onclick="loadFrequency(462.5625)">GMRS 462</button>
                        <button class="preset-btn" onclick="loadFrequency(144.2)">2M Beacon</button>
                        <button class="preset-btn" onclick="loadFrequency(121.5)">Emergency</button>
                    </div>
                </div>
            </div>
            <!-- Spectrum Display -->
            <div>
                <!-- Signal Strength Meter -->
                <div class="spectrum-display" id="rf-waterfall">
                    <h3 style="margin: 0 0 15px 0; color: #2196F3;">SIGNAL ANALYSIS</h3>
                    
                    <div class="signal-meter">
                        <div class="meter-label">S-Meter (Signal Strength)</div>
                        <div class="meter-bar">
                            <div class="meter-fill" id="sMeter" style="width: 65%;">S 8</div>
                        </div>
                    </div>
                    <!-- Spectrum Canvas -->
                    <div class="meter-label">Frequency Spectrum</div>
                    <canvas id="spectrumCanvas" class="spectrum-canvas"></canvas>
                    <!-- Signal Stats -->
                    <table class="info-table">
                        <tr>
                            <td>Signal Strength</td>
                            <td id="signalStrength">-65 dBm</td>
                        </tr>
                        <tr>
                            <td>Noise Level</td>
                            <td id="noiseLevel">-90 dBm</td>
                        </tr>
                        <tr>
                            <td>SNR</td>
                            <td id="snr">25 dB</td>
                        </tr>
                        <tr>
                            <td>Modulation</td>
                            <td id="modulation">FM</td>
                        </tr>
                        <tr>
                            <td>Bandwidth</td>
                            <td id="bandwidth">12.5 kHz</td>
                        </tr>
                    </table>
                </div>
                <!-- Receiver Info -->
                <div class="spectrum-display" id="reciever-status">
                    <h3 style="margin: 0 0 15px 0; color: #2196F3;">RECEIVER STATUS</h3>
                    <table class="info-table">
                        <tr>
                            <td>Device</td>
                            <td>RTL-SDR (Generic)</td>
                        </tr>
                        <tr>
                            <td>Tuner</td>
                            <td>Rafael Micro R820T</td>
                        </tr>
                        <tr>
                            <td>Gain</td>
                            <td id="gainValue">37 dB</td>
                        </tr>
                        <tr>
                            <td>Sample Rate</td>
                            <td>2.048 MSPS</td>
                        </tr>
                        <tr>
                            <td>Status</td>
                            <td style="color: #00FF00;">‚óè ACTIVE</td>
                        </tr>
                    </table>
                    <!-- Gain Control -->
                    <div style="margin-top: 20px;">
                        <label class="control-label">Gain Control</label>
                        <input type="range" min="0" max="50" value="37" id="gainControl" 
                               style="width: 100%; cursor: pointer;" onchange="adjustGain(this.value)">
                        <div style="color: #AAA; font-size: 11px; margin-top: 5px; text-align: center;">
                            <span id="gainDisplay">37 dB</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    <!-- SIGNAL TRIANGULATION / DIRECTION FINDING -->
<section class="panel" id="triangulation-section">
    <h2>üìê SIGNAL TRIANGULATION & ORIGIN ESTIMATION</h2>
    <p style="color:#AAA;margin:0;">
        Direction-of-arrival analysis, multi-receiver bearing correlation, and estimated emitter location
    </p>
</section>

<div class="triangulation-grid" id="signal-triangulation">
    <!-- Compass / Bearing Visualization -->
    <div class="tri-card">
        <h3>BEARING / CARDINAL ORIENTATION</h3>
        <canvas id="bearingCompass" width="270" height="270"></canvas>

        <div class="bearing-readout">
            <div><span>Primary Bearing:</span> <strong id="primaryBearing">072¬∞ (ENE)</strong></div>
            <div><span>Confidence:</span> <strong id="bearingConfidence">¬±6¬∞</strong></div>
            <div><span>Signal Class:</span> <strong>VHF FM</strong></div>
        </div>
    </div>

    <!-- Receiver Bearings -->
    <div class="tri-card">
        <h3>RECEIVER BEARINGS</h3>
        <table class="info-table">
            <tr>
                <th>Receiver</th>
                <th>Bearing</th>
                <th>RSSI</th>
                <th>Status</th>
            </tr>
            <tr>
                <td>ADS-B Node</td>
                <td>068¬∞</td>
                <td>-61 dBm</td>
                <td style="color:#00FF00;">‚óè LOCK</td>
            </tr>
            <tr>
                <td>Tx/Rx Node</td>
                <td>081¬∞</td>
                <td>-67 dBm</td>
                <td style="color:#FFB300;">‚óè DEGRADED</td>
            </tr>
            <tr>
                <td>Mesh Node</td>
                <td>074¬∞</td>
                <td>-64 dBm</td>
                <td style="color:#00FF00;">‚óè LOCK</td>
            </tr>
        </table>
    </div>
    <!-- Triangulation Map -->
    <div class="tri-card tri-map-card" id="triangulation-map">
        <h3>ESTIMATED SIGNAL ORIGIN</h3>
        <div class="map-guard tri">
            <div id="triangulationMap"></div>
            <div class="map-overlay" aria-hidden="true"></div>
        </div>
        <div class="tri-meta">
            <div><span>Estimated Error Radius:</span> <strong>¬±420 m</strong></div>
            <div><span>Solution Quality:</span> <strong style="color:#00FF00;">HIGH</strong></div>
            <div><span>Last Update:</span> <strong id="triUpdate">0.0s ago</strong></div>
        </div>
    </div>
</div>
    </main>
    <footer id="footer-embed-container"></footer>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://rawcdn.githack.com/bbecquet/Leaflet.RotatedMarker/master/leaflet.rotatedMarker.js"></script>
    <script>
        // Node positions for triangulation
        const nodes = {
            "Tx/Rx Node": { lat: 37.7750, lon: -122.4183 },
            "Mesh Node": { lat: 37.7765, lon: -122.4170 },
            "ADS-B Node": { lat: 37.7740, lon: -122.4190 } // ignored for triangulation
        };
        // Convert degrees to radians
        function deg2rad(deg) {
            return deg * Math.PI / 180;
        }
        // Simple triangulation: intersect two bearings
        function triangulate(nodeData) {
            const nodeKeys = Object.keys(nodeData).filter(k => k !== 'ADS-B Node');
            if (nodeKeys.length < 2) return null;
            const [nodeA, nodeB] = nodeKeys;
            const posA = nodes[nodeA];
            const posB = nodes[nodeB];
            const bearingA = parseFloat(document.querySelector(
                `tr:has(td:contains("${nodeA}")) td:nth-child(2)`
            )?.textContent) || 0;
            const bearingB = parseFloat(document.querySelector(
                `tr:has(td:contains("${nodeB}")) td:nth-child(2)`
            )?.textContent) || 0;
            const thetaA = deg2rad(bearingA);
            const thetaB = deg2rad(bearingB);
            const x1 = posA.lon, y1 = posA.lat;
            const x2 = posB.lon, y2 = posB.lat;
            const m1 = Math.tan(thetaA);
            const m2 = Math.tan(thetaB);
            const denom = m1 - m2;
            if (Math.abs(denom) < 0.0001) return null;
           const x = (m1*x1 - m2*x2 + y2 - y1) / denom;
            const y = y1 + m1 * (x - x1);
            return [y, x];
        }
        function updateTriangulation() {
            const estimated = triangulate(nodes);
            if (!estimated) return;
            const [lat, lon] = estimated;
            // Use global marker variables
            if (!window.triangulationMarker) {
                window.triangulationMarker = L.marker([lat, lon], {
                    icon: L.divIcon({
                        html: '<div style="background:#FF1744;color:#000;padding:4px 8px;border-radius:3px;font-size:12px;font-weight:bold;border:2px solid #FF1744;box-shadow:0 0 10px rgba(255,23,68,0.5)">ESTIMATED ORIGIN</div>',
                        className: 'tri-marker',
                        iconSize: [100, 30],
                        iconAnchor: [50, 15]
                    })
                }).addTo(triangulationMap);
            } else {
                window.triangulationMarker.setLatLng([lat, lon]);
            }
            const errorRadiusMeters = 420;
            if (!window.errorCircle) {
                window.errorCircle = L.circle([lat, lon], {
                    radius: errorRadiusMeters,
                    color: '#FF1744',
                    fillColor: 'rgba(255,23,68,0.1)',
                    weight: 2
                }).addTo(triangulationMap);
            } else {
                window.errorCircle.setLatLng([lat, lon]);
                window.errorCircle.setRadius(errorRadiusMeters);
            }
    frameTriangulationMap(lat, lon);

        }
        setInterval(updateTriangulation, 3000);
    </script>
<script>
/* ===== MAP FRAMING HELPER ===== */
function fitMapToPoints(map, points, options = {}) {
    if (!map || !points || points.length === 0) return;

    const bounds = L.latLngBounds(points);

    map.fitBounds(bounds, {
        padding: options.padding || [40, 40],
        maxZoom: options.maxZoom || 15,
        animate: options.animate !== false
    });
}
</script>

    <!--ADS-B / UAT Map Logic-->
<script>
    let map;
    let aircraft = [];
    let markers = {};
    let selectedAircraftId = null;
    let trackingEnabled = false;
    let refreshInterval = 5;
    let planeIcon; // initialized AFTER Leaflet exists

    // Initialize map
    function initMap() {
        map = L.map('map').setView([37.7749, -122.4194], 8);

L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '¬© OpenStreetMap ¬© CARTO',
    subdomains: 'abcd',
    maxZoom: 19
}).addTo(map);


        // Plane icon MUST be created after Leaflet loads
        planeIcon = L.icon({
            iconUrl: '/static/icons/plane-icon.svg',
            iconSize: [40, 40],
            iconAnchor: [20, 20] // center rotation
        });
    }

    // Load aircraft data
    async function loadAircraft() {
        try {
            const response = await fetch('/api/nodes/isr/adsb/aircraft');
            const data = await response.json();

            aircraft = data.aircraft || [];

            updateAircraftDisplay();
            updateStats();
            updateMap();
            updateAircraftList();
        } catch (error) {
            console.error('Error loading aircraft:', error);
        }
    }

    // Update aircraft display on map
    function updateMap() {
        const seen = new Set();

        aircraft.forEach(ac => {
            if (!ac.latitude || !ac.longitude || !ac.icao) return;

            seen.add(ac.icao);

            const heading =
                typeof ac.heading === 'number' ? ac.heading : 0;

            // EXISTING marker ‚Üí move + rotate
            if (markers[ac.icao]) {
                markers[ac.icao]
                    .setLatLng([ac.latitude, ac.longitude])
                    .setRotationAngle(heading);
                return;

            }

            // NEW marker ‚Üí create once
            const marker = L.marker(
                [ac.latitude, ac.longitude],
                {
                    icon: planeIcon,
                    rotationAngle: heading,
                    rotationOrigin: 'center center'
                }
            )
            .addTo(map)
            .bindPopup(`
                <strong>${ac.callsign || 'Unknown'}</strong><br>
                ICAO: ${ac.icao}<br>
                Alt: ${ac.altitude} ft<br>
                Speed: ${ac.speed} kts<br>
                Heading: ${ac.heading ?? 'N/A'}¬∞
            `)
            .on('click', () => selectAircraft(ac));

            markers[ac.icao] = marker;
        });

        // Remove stale aircraft markers
        for (const icao in markers) {
            if (!seen.has(icao)) {
                map.removeLayer(markers[icao]);
                delete markers[icao];
            }
        }
            updateBearingRays(
    selectedAircraftId
        ? aircraft.filter(a => a.icao === selectedAircraftId)
        : aircraft
);

/* Auto-frame ADS-B map */
const framePoints = aircraft
    .filter(a => a.latitude && a.longitude)
    .map(a => [a.latitude, a.longitude]);

if (window.nodes) {
    Object.values(nodes).forEach(n => framePoints.push([n.lat, n.lon]));
}

fitMapToPoints(map, framePoints, { maxZoom: 12 });

    }

    // Update aircraft list
    function updateAircraftList() {
        const container = document.getElementById('aircraftListContainer');

        if (aircraft.length === 0) {
            container.innerHTML =
                '<div style="color: #AAA; text-align: center; padding: 20px;">No aircraft detected</div>';
            return;
        }

        container.innerHTML = aircraft.map(ac => `
            <div class="aircraft-item ${ac.icao === selectedAircraftId ? 'selected' : ''}"
                 onclick="selectAircraft(${JSON.stringify(ac).replace(/"/g, '&quot;')})">
                <div class="callsign">${ac.callsign || 'UNKNOWN'}</div>
                <div class="icao">${ac.icao}</div>
                <div class="stats">
                    <strong>${ac.altitude}</strong> ft<br>
                    <strong>${ac.speed}</strong> kts<br>
                    ${typeof ac.heading === 'number'
                        ? `<strong>Hdg:</strong> ${ac.heading}¬∞<br>`
                        : ''}
                </div>
            </div>
        `).join('');
    }

    // Select aircraft
    function selectAircraft(ac) {
        selectedAircraftId = ac.icao;

        const details = document.getElementById('selectedAircraft');
        details.innerHTML = `
            <div style="text-align: left;">
                <h4 style="color: #00FF00; margin: 0 0 10px 0;">
                    ${ac.callsign || 'UNKNOWN'}
                </h4>
                <table style="width: 100%; font-size: 12px; color: #AAA;">
                    <tr><td><strong>ICAO:</strong></td><td style="color:#00FF00">${ac.icao}</td></tr>
                    <tr><td><strong>Altitude:</strong></td><td style="color:#00FF00">${ac.altitude} ft</td></tr>
                    <tr><td><strong>Speed:</strong></td><td style="color:#00FF00">${ac.speed} kts</td></tr>
                    <tr><td><strong>Heading:</strong></td><td style="color:#00FF00">${ac.heading ?? 'N/A'}¬∞</td></tr>
                    <tr>
                        <td><strong>Position:</strong></td>
                        <td style="color:#00FF00">
                            ${ac.latitude?.toFixed(4)}, ${ac.longitude?.toFixed(4)}
                        </td>
                    </tr>
                </table>
            </div>
        `;

        updateAircraftList();
    }

    // Update statistics
    function updateStats() {
        document.getElementById('aircraftCount').textContent = aircraft.length;
        document.getElementById('messageRate').textContent =
            Math.floor(Math.random() * 100 + 50);

        if (aircraft.length > 0) {
            const maxAlt = Math.max(...aircraft.map(a => a.altitude || 0));
            const avgSpeed = Math.round(
                aircraft.reduce((sum, a) => sum + (a.speed || 0), 0) / aircraft.length
            );

            document.getElementById('maxAltitude').textContent = `${maxAlt} ft`;
            document.getElementById('avgSpeed').textContent = `${avgSpeed} kts`;
        }
    }

    // Placeholder for filters
    function updateAircraftDisplay() {
        const typeFilter = document.getElementById('typeFilter').value;
        const minAlt = parseInt(document.getElementById('minAltitude').value) || 0;
    }

    // Toggle tracking
    function toggleTracking() {
        trackingEnabled = !trackingEnabled;

        const btn = event.target;
        btn.textContent = trackingEnabled ? '‚èπ Stop Tracking' : '‚ñ∂ Start Tracking';
        btn.className = trackingEnabled ? 'btn btn-danger' : 'btn btn-primary';

        if (trackingEnabled) {
            loadAircraft();
            startAutoRefresh();
        }
    }

    // Auto-refresh
    function startAutoRefresh() {
        refreshInterval =
            parseInt(document.getElementById('refreshInterval').value) || 5;

        if (trackingEnabled) {
            loadAircraft();
            setTimeout(startAutoRefresh, refreshInterval * 1000);
        }
    }

    // Initialize
    initMap();
    loadAircraft();
</script>
<script>
/* ===== ADS-B BEARING RAYS ===== */

const bearingRays = {};

/* Simple geographic bearing ray */
function bearingRay(lat, lon, bearingDeg, lengthKm = 80) {
    const rad = bearingDeg * Math.PI / 180;
    const dLat = (Math.cos(rad) * lengthKm) / 111;
    const dLon = (Math.sin(rad) * lengthKm) / (111 * Math.cos(lat * Math.PI / 180));

    return [
        [lat, lon],
        [lat + dLat, lon + dLon]
    ];
}

function updateBearingRays(aircraftList) {
    if (!map || !window.nodes) return;

    /* Clear old rays */
    Object.values(bearingRays).forEach(ray => map.removeLayer(ray));
    Object.keys(bearingRays).forEach(k => delete bearingRays[k]);

    aircraftList.forEach(ac => {
        if (!ac.heading || !ac.icao) return;

        Object.entries(nodes).forEach(([nodeName, node]) => {
            const key = `${nodeName}-${ac.icao}`;

            const path = bearingRay(
                node.lat,
                node.lon,
                ac.heading,
                80
            );

            bearingRays[key] = L.polyline(path, {
                color: '#FFB300',
                weight: 1.5,
                dashArray: '6,4',
                opacity: 0.7
            }).addTo(map);
        });
    });
}
</script>

<!--Demo Waterfall Logic-->
    <script>
        (() => {
            const canvas = document.getElementById("spectrumCanvas");
            if (!canvas) return;
            const ctx = canvas.getContext("2d");
            /* ================= CONFIG ================= */
            const FREQ_BINS = 512;
            let UPDATE_MS = 45;
            let GAIN = 1.0;
            let paused = false;
            const NOISE_BASE = 0.28;
            const NOISE_VAR  = 0.08;
            let centerFreq = 146.520; // MHz example
            let spanMHz = 2;           // visible spectrum span
            let xOffset = 0;           // horizontal pan
            /* ================= CANVAS INIT ================= */
            function initCanvas() {
                const rect = canvas.getBoundingClientRect();
                canvas.width  = FREQ_BINS;
                canvas.height = Math.floor(rect.height);
                ctx.imageSmoothingEnabled = false;
            }
            initCanvas();
            window.addEventListener("resize", initCanvas);
            /* ================= UI CONTROLS ================= */
            const controls = document.createElement("div");
            controls.style.cssText = `
                display:flex;
                gap:8px;
                margin-top:6px;
                align-items:center;
                font-size:12px;
            `;
            function button(label, fn) {
                const b = document.createElement("button");
                b.textContent = label;
                b.onclick = fn;
                return b;
            }
            function slider(min, max, step, val, fn) {
                const s = document.createElement("input");
                s.type = "range";
                s.min = min;
                s.max = max;
                s.step = step;
                s.value = val;
                s.oninput = e => fn(parseFloat(e.target.value));
                return s;
            }
            controls.append(
                button("Pause", () => paused = !paused),
                button("Snapshot", () => snapshotWaterfall()),
                document.createTextNode("Gain"),
                slider(0.5, 2.5, 0.1, GAIN, v => GAIN = v)
            );
            canvas.parentElement.appendChild(controls);
            /* ================= SIGNAL STATE ================= */
            const carriers = [
                { f: 120, bw: 3, p: 0.45, d: 0.02 },
                { f: 320, bw: 4, p: 0.35, d: -0.015 }
            ];
            let burst = null;
            let lastDetected = null;
            /* ================= COLOR MAP ================= */
            function powerToColor(p) {
                p = Math.max(0, Math.min(1, p * GAIN));
                p = Math.pow(p, 0.6);
                let r=0,g=0,b=0;
                if (p < 0.25) {
                    b = 60 + p*4*100;  // blue-green base
                    g = p*4*140;
                } else if (p < 0.5) {
                    g = 140 + (p-0.25)*4*100;
                    b = 200 - (p-0.25)*4*60;
                } else if (p < 0.75) {
                    r = (p-0.5)*4*180;
                    g = 240;
                } else {
                    r = 255;
                    g = 240 - (p-0.75)*4*160;
                }
                return [r|0,g|0,b|0];
            }
            /* ================= FFT FRAME ================= */
            function generateFrame() {
                const frame = new Float32Array(FREQ_BINS);
                for (let i=0;i<FREQ_BINS;i++) {
                    frame[i] = NOISE_BASE + Math.random()*NOISE_VAR;
                }
                for (const c of carriers) {
                    c.f += c.d;
                    if (c.f < 20 || c.f > FREQ_BINS-20) c.d *= -1;
                    const f = c.f|0;
                    for (let i=-c.bw;i<=c.bw;i++) {
                        const idx = f+i;
                        if (idx>=0 && idx<FREQ_BINS)
                            frame[idx]+=c.p*Math.exp(-Math.abs(i));
                    }
                }
                if (!burst && Math.random()<0.02) {
                    burst = {
                        f: Math.random()*FREQ_BINS|0,
                        bw: 6,
                        life: 30,
                        p: 0.7
                    };
                    lastDetected = burst.f;
                }
                if (burst) {
                    for (let i=-burst.bw;i<=burst.bw;i++) {
                        const idx = burst.f+i;
                        if (idx>=0 && idx<FREQ_BINS)
                            frame[idx]+=burst.p*Math.exp(-Math.abs(i));
                    }
                    burst.life--;
                    if (burst.life<=0) burst=null;
                }
                return frame;
            }
            /* ================= OVERLAYS ================= */
            function drawOverlays() {
                ctx.save();
                const w = canvas.width;
                const h = canvas.height;
                // Center window
                const winWidth = w * 0.1;
                const x1 = w/2 - winWidth/2;
                const x2 = w/2 + winWidth/2;
                ctx.fillStyle = "rgba(0,0,0,0.005)";
                ctx.fillRect(x1, 0, winWidth, h);
                ctx.strokeStyle = "rgba(0,0,0,0.1)";
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(x1,0); ctx.lineTo(x1,h);
                ctx.moveTo(x2,0); ctx.lineTo(x2,h);
                ctx.stroke();
                // Signal detection marker
                if (lastDetected!==null) {
                    ctx.strokeStyle="rgba(255,0,0,0.6)";
                    ctx.beginPath();
                    ctx.moveTo(lastDetected, h-10);
                    ctx.lineTo(lastDetected, h);
                    ctx.stroke();
                }
                ctx.restore();
            }
            /* ================= MOUSE HUD ================= */
            canvas.addEventListener("mousemove", e=>{
                const r = canvas.getBoundingClientRect();
                const x = e.clientX - r.left;
                const bin = Math.floor(x / r.width * FREQ_BINS);
                canvas.title = `Freq Bin: ${bin}`;
            });
            /* ================= SNAPSHOT WITH METADATA ================= */
            function snapshotWaterfall() {
                const tmpCanvas = document.createElement('canvas');
                tmpCanvas.width = canvas.width;
                tmpCanvas.height = canvas.height;
                const tmpCtx = tmpCanvas.getContext('2d');
                tmpCtx.drawImage(canvas,0,0);
                tmpCtx.fillStyle = 'rgba(0,0,0,0.6)';
                tmpCtx.fillRect(5,5,240,50);
                tmpCtx.fillStyle = '#00FF00';
                tmpCtx.font = '12px monospace';
                tmpCtx.fillText(`Time: ${new Date().toLocaleString()}`, 10, 20);
                tmpCtx.fillText(`Center Freq: ${centerFreq.toFixed(3)} MHz`, 10, 35);
                tmpCtx.fillText(`Span: ${spanMHz.toFixed(3)} MHz`, 10, 50);
                tmpCtx.fillText(`Gain: ${GAIN.toFixed(2)}`, 10, 65);
                const link = document.createElement('a');
                link.download = `waterfall_${Date.now()}.png`;
                link.href = tmpCanvas.toDataURL();
                link.click();
            }
            /* ================= MAIN LOOP ================= */
            function tick() {
                if (!paused) {
                    // scroll existing image up by 1 pixel
                    ctx.drawImage(canvas,0,1,FREQ_BINS,canvas.height-1,0,0,FREQ_BINS,canvas.height-1);
                    const frame = generateFrame();
                    const row = ctx.createImageData(FREQ_BINS,1);
                    for (let i=0;i<FREQ_BINS;i++) {
                        const [r,g,b] = powerToColor(frame[i]);
                        const o=i*4;
                        row.data[o]=r;
                        row.data[o+1]=g;
                        row.data[o+2]=b;
                        row.data[o+3]=255;
                    }
                    ctx.putImageData(row,0,canvas.height-1);
                }
                drawOverlays();
                setTimeout(tick, UPDATE_MS);
            }
            tick();
            /* ================= X-AXIS PAN ================= */
            document.addEventListener('keydown', e=>{
                if (e.key==='ArrowLeft') xOffset -= 10;
                if (e.key==='ArrowRight') xOffset += 10;
                xOffset = Math.max(0,xOffset);
            });
        })();
    </script>
<!-- SIGNALS TRIANGULATION VISUALS -->
    <script>
        function normalizeCanvas(canvas) {
        const rect = canvas.getBoundingClientRect();
        canvas.width  = rect.width;
        canvas.height = rect.height;
        }
        function drawCompass(bearingDeg) {
        const canvas = document.getElementById('bearingCompass');
            if (!canvas) {
            console.error('bearingCompass not found');
            return;
            }
        normalizeCanvas(canvas);
        const ctx = canvas.getContext('2d');
        const w = canvas.width;
        const h = canvas.height;
        const c = w / 2;
        const r = c - 12;
        ctx.clearRect(0, 0, w, h);
        /* Outer ring */
        ctx.strokeStyle = '#00FF00';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(c, c, r, 0, Math.PI * 2);
        ctx.stroke();
        /* Cardinal ticks */
        ctx.strokeStyle = 'rgba(0,255,0,0.4)';
        ctx.lineWidth = 1;
        for (let i = 0; i < 360; i += 30) {
            const a = (i - 90) * Math.PI / 180;
            ctx.beginPath();
            ctx.moveTo(
                c + Math.cos(a) * (r - 8),
                c + Math.sin(a) * (r - 8)
            );
            ctx.lineTo(
                c + Math.cos(a) * r,
                c + Math.sin(a) * r
            );
            ctx.stroke();
        }
        /* Cardinal labels */
        ctx.fillStyle = '#00FF00';
        ctx.font = 'bold 14px monospace';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('N', c, 14);
        ctx.fillText('S', c, h - 14);
        ctx.fillText('E', w - 14, c);
        ctx.fillText('W', 14, c);
        /* Bearing needle */
        const rad = (bearingDeg - 90) * Math.PI / 180;
        ctx.strokeStyle = '#FF1744';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(c, c);
        ctx.lineTo(
            c + Math.cos(rad) * (r - 16),
            c + Math.sin(rad) * (r - 16)
        );
        ctx.stroke();
        /* Center dot */
        ctx.fillStyle = '#FF1744';
        ctx.beginPath();
        ctx.arc(c, c, 4, 0, Math.PI * 2);
        ctx.fill();
        }
        document.addEventListener('DOMContentLoaded', () => {
            // Draw initial compass
            drawCompass(72); // example bearing
            // Optional: demo auto-update
            setInterval(() => {
                const bearing = 68 + Math.random() * 12;
                document.getElementById('primaryBearing').textContent =
                    `${bearing.toFixed(0)}¬∞`;
                drawCompass(bearing);
            }, 3000);
        });
    </script>
    <script>
    let triangulationMap;

    function initTriangulationMap() {
        triangulationMap = L.map('triangulationMap', {
            zoomControl: false,
            attributionControl: false
        }).setView([37.7749, -122.4194], 13);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(triangulationMap);
    }
    document.addEventListener('DOMContentLoaded', initTriangulationMap);
</script>
<!--Triangulation Markers-->
    <script>
        // Global variables (declare once)
        window.triangulationMarker = null;
        window.errorCircle = null;
        /**
        * Update or create triangulation marker with optional error radius
        * @param {number} lat - Latitude of estimated origin
        * @param {number} lng - Longitude of estimated origin
        * @param {object} options - Optional settings
        *        options.errorRadius (m)
        *        options.popupText (string)
        *        options.pan (bool)
        */
        function updateTriangulationMarker(lat, lng, options = {}) {
            if (!triangulationMap) return;
            // Create or move marker
            if (window.triangulationMarker) {
                window.triangulationMarker.setLatLng([lat, lng]);
            } else {
                const markerIcon = L.divIcon({
                    html: `<div style="
                        width: 20px;
                        height: 20px;
                        background: rgba(255,23,68,0.8);
                        border: 2px solid #FF1744;
                        border-radius: 50%;
                        box-shadow: 0 0 12px rgba(255,23,68,0.8);
                    "></div>`,
                    className: '',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });
                window.triangulationMarker = L.marker([lat, lng], { icon: markerIcon })
                    .addTo(triangulationMap)
                    .bindPopup(options.popupText || 'Estimated Signal Origin');
            }
            // Error circle
            if (options.errorRadius) {
                if (window.errorCircle) {
                    window.errorCircle.setLatLng([lat, lng]);
                    window.errorCircle.setRadius(options.errorRadius);
                } else {
                    window.errorCircle = L.circle([lat, lng], {
                        radius: options.errorRadius,
                        color: '#FF1744',
                        fillColor: 'rgba(255,23,68,0.2)',
                        weight: 2,
                        fillOpacity: 0.2
                    }).addTo(triangulationMap);
                }
            }
            // Pan map
            if (options.pan) triangulationMap.panTo([lat, lng]);
        }
        // Example usage: initial placement
        document.addEventListener('DOMContentLoaded', () => {
            updateTriangulationMarker(37.7749, -122.4194, {
                errorRadius: 420,
                popupText: 'Estimated Signal Source',
                pan: true
            });
            // Optional: auto-update demo
            setInterval(() => {
                const newLat = 37.7749 + (Math.random() - 0.5) * 0.01;
                const newLng = -122.4194 + (Math.random() - 0.5) * 0.01;
                updateTriangulationMarker(newLat, newLng, {
                    errorRadius: 420,
                    popupText: 'Estimated Signal Source',
                    pan: false
                });
                const secondsAgo = ((Math.random() * 5) + 1).toFixed(1);
                document.getElementById('triUpdate').textContent = `${secondsAgo}s ago`;
            }, 5000);
        });
    </script>
<!--Triangulation Node Positions-->

    <script>
/* ===== TRIANGULATION MAP FRAMING ===== */
function frameTriangulationMap(lat, lon) {
    if (!triangulationMap || !window.nodes) return;

    const points = [
        ...Object.values(nodes).map(n => [n.lat, n.lon]),
        [lat, lon]
    ];

    fitMapToPoints(triangulationMap, points, {
        maxZoom: 16
    });
}
</script>

<!--Node Actions Modal-->
    <script>
        const modal = document.getElementById('node-modal');
        const modalNodeName = document.getElementById('modal-node-name');
        let currentNode = '';
        function openNodeModal(nodeName){
        currentNode = nodeName;
        modalNodeName.textContent = nodeName + " Node Actions";
        modal.style.display = "block";
        }
        function closeNodeModal(){
        modal.style.display = "none";
        }
        function rebootNode(){
          alert(currentNode + " node reboot triggered!");
        }
        function runDiagnostics(){
          alert("Running diagnostics on " + currentNode + " node.");
        }
        window.onclick = function(event){
          if(event.target == modal){ closeNodeModal(); }
        }
        // Toggle alerts
        document.querySelectorAll('.alert-icon').forEach(icon => {
          icon.addEventListener('click', e => {
            e.preventDefault();
            icon.parentElement.querySelector('.alert-panel').classList.toggle('visible');
          });
        });
    </script>
<!--Toggle Sidebar Logic-->

<!--Prevent Accidential Map Interactions-->
    <script>
        (() => {
            const mapGuards = document.querySelectorAll('.map-guard');
            mapGuards.forEach(guard => {
                const overlay = guard.querySelector('.map-overlay');
                if (!overlay) return;
                let blockTimer = null;
                guard.addEventListener('mouseenter', () => {
                    overlay.classList.add('active');
                    blockTimer = setTimeout(() => {
                        overlay.classList.remove('active');
                        blockTimer = null;
                    }, 900);
                });
                guard.addEventListener('mouseleave', () => {
                    overlay.classList.remove('active');
                    if (blockTimer) {
                        clearTimeout(blockTimer);
                        blockTimer = null;
                    }
                });
            });
        })();
    </script>
</body>
</html>
