<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airspace / RF Monitoring - Tactical Dashboard</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
</head>
<body>
    {% if demo_mode %}
    <div class="demo-mode">‚ö† DEMO MODE - No Cluster Connected</div>
    {% endif %}
    <!-- Collapsible Quick Nav Sidebar -->
<aside id="quick-sidebar" class="quick-sidebar collapsed">
    <button class="sidebar-toggle vertical-label" onclick="toggleSidebar()" title="Quick Navigation">
        <svg width="24px" height="24px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g id="Interface / Drag_Horizontal"> <g id="Vector"> <path d="M18 14C17.4477 14 17 14.4477 17 15C17 15.5523 17.4477 16 18 16C18.5523 16 19 15.5523 19 15C19 14.4477 18.5523 14 18 14Z" stroke="rgba(255, 179, 0, 0.4)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M12 14C11.4477 14 11 14.4477 11 15C11 15.5523 11.4477 16 12 16C12.5523 16 13 15.5523 13 15C13 14.4477 12.5523 14 12 14Z" stroke="rgba(255, 179, 0, 0.4)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M6 14C5.44772 14 5 14.4477 5 15C5 15.5523 5.44772 16 6 16C6.55228 16 7 15.5523 7 15C7 14.4477 6.55228 14 6 14Z" stroke="rgba(255, 179, 0, 0.4)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M18 8C17.4477 8 17 8.44772 17 9C17 9.55228 17.4477 10 18 10C18.5523 10 19 9.55228 19 9C19 8.44772 18.5523 8 18 8Z" stroke="rgba(255, 179, 0, 0.4)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M12 8C11.4477 8 11 8.44772 11 9C11 9.55228 11.4477 10 12 10C12.5523 10 13 9.55228 13 9C13 8.44772 12.5523 8 12 8Z" stroke="rgba(255, 179, 0, 0.4)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M6 8C5.44772 8 5 8.44772 5 9C5 9.55228 5.44772 10 6 10C6.55228 10 7 9.55228 7 9C7 8.44772 6.55228 8 6 8Z" stroke="rgba(255, 179, 0, 0.4)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> </g> </g> </g></svg>
        Quick Nav Panel
    </button>
    <nav class="sidebar-content">
        <h4>Quick Nav Panel</h4>
        <a href="#adsb-section">ADS-B / UAT</a>
        <a href="#controls-section">Tracking Controls</a>
        <a href="#map-section">Live Map</a>
        <a href="#aircraft-section">Aircraft List</a>
        <a href="#">SDR Frequency Control</a>
        <a href="#">Signal Analysis</a>
        <a href="#">Reciever Status</a>
        <a href="#">Inbound Signals Triangulation</a>
    </nav>
</aside>
<nav class="navbar" id="main-navbar">
    <!-- COLLAPSE ANCHOR (REQUIRED) -->
    <div class="nav-collapse-anchor">
        <!-- Left column: brand + nav links -->
        <div class="nav-left">
            <div class="nav-brand">‚åò Modern Warrior Systems</div>
            <div class="nav-links">
                <a href="/">Dashboard</a>
                <a href="/monitor">Cluster Health</a>
                <a href="/control">Control</a>
                <div class="nav-dropdown">
                    <a href="/tools" class="nav-parent active">Tools</a>
                    <div class="dropdown-menu">
                        <a href="/isr" class="active">ADSB / UAT / SDR</a>
                        <a href="/mesh">Mesh Networking</a>
                        <a href="/vhf">RF Communication</a>
                        <a href="/backup">Backup & Restore</a>
                    </div>
                </div>
                <a href="/settings">Settings</a>
                <!-- Tactical alert icon -->
                <div class="nav-alert">
                    <button href="#" class="alert-icon" title="Notifications">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"
                             viewBox="0 0 24 24" fill="none" stroke="currentColor"
                             stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M10.29 3.86L1.82 18a1 1 0 0 0 .87 1.5h18.62a1 1 0 0 0 .87-1.5L13.71 3.86a1 1 0 0 0-1.42 0z"/>
                            <line x1="12" y1="9" x2="12" y2="13"/>
                            <line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                        <span class="alert-badge">3</span>
                        <div class="alert-panel">
                            <div class="alert-item alert-warn">
                                <div class="alert-dot"></div>
                                <div class="alert-text">
                                    ADS-B Node high temp <span class="alert-meta">71¬∞C</span>
                                </div>
                            </div>
                            <div class="alert-item alert-down">
                                <div class="alert-dot"></div>
                                <div class="alert-text">
                                    Tx/Rx Node offline
                                </div>
                            </div>
                            <div class="alert-item alert-warn">
                                <div class="alert-dot"></div>
                                <div class="alert-text">
                                    Mesh Node CPU high <span class="alert-meta">88%</span>
                                </div>
                            </div>
                            <div class="alert-logs">
                                <div class="alert-log">[12:02] ADS-B Node temp spike detected</div>
                                <div class="alert-log">[12:01] Tx/Rx Node lost connectivity</div>
                                <div class="alert-log">[12:00] Mesh Node CPU > 85%</div>
                            </div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
        <!-- Right column: node status -->
        <div class="nav-status">
            <div class="node-status ok">
                <button class="node-btn" title="Reboot Boot Node">‚≠Æ</button>
                Boot
                <div class="node-tooltip">
                    <div class="tooltip-item"><span>CPU:</span><div class="tooltip-bar"><div class="tooltip-fill" style="width:52%;"></div></div></div>
                    <div class="tooltip-item"><span>Temp:</span><div class="tooltip-bar"><div class="tooltip-fill" style="width:45%;"></div></div></div>
                </div>
            </div>
            <div class="node-status warn">
                <button class="node-btn" title="Reboot ADS-B Node">‚≠Æ</button>
                ADS-B
                <div class="node-tooltip">
                    <div class="tooltip-item"><span>CPU:</span><div class="tooltip-bar"><div class="tooltip-fill" style="width:78%;"></div></div></div>
                    <div class="tooltip-item"><span>Temp:</span><div class="tooltip-bar"><div class="tooltip-fill" style="width:71%;"></div></div></div>
                </div>
            </div>
            <div class="node-status ok">
                <button class="node-btn" title="Reboot Mesh Node">‚≠Æ</button>
                Mesh
                <div class="node-tooltip">
                    <div class="tooltip-item"><span>CPU:</span><div class="tooltip-bar"><div class="tooltip-fill" style="width:48%;"></div></div></div>
                    <div class="tooltip-item"><span>Temp:</span><div class="tooltip-bar"><div class="tooltip-fill" style="width:50%;"></div></div></div>
                </div>
            </div>
            <div class="node-status down">
                <button class="node-btn" title="Reboot Tx/Rx Node">‚≠Æ</button>
                Tx/Rx
                <div class="node-tooltip">
                    <div class="tooltip-item"><span>CPU:</span><div class="tooltip-bar"><div class="tooltip-fill" style="width:0%;"></div></div></div>
                    <div class="tooltip-item"><span>Temp:</span><div class="tooltip-bar"><div class="tooltip-fill" style="width:0%;"></div></div></div>
                </div>
            </div>
        </div>
    </div>
</nav>
    <main class="container">
        <section class="panel" id="adsb-section">
            <h2>üì° ADSB/UAT AIRCRAFT TRACKING</h2>
            <p style="color: #AAA; margin: 0;">Airspace Monitoring Tools</p>
        </section>
        <!-- Statistics Panel -->
        <div class="stats-panel">
            <div class="stat-card">
                <div class="stat-label">Aircraft Tracked</div>
                <div class="stat-value" id="aircraftCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Messages/sec</div>
                <div class="stat-value" id="messageRate">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Max Altitude</div>
                <div class="stat-value" id="maxAltitude">0 ft</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg Speed</div>
                <div class="stat-value" id="avgSpeed">0 kts</div>
            </div>
        </div>
        <!-- Map -->
        <div class="card">
            <h2>LIVE AIRCRAFT MAP</h2>
            <div class="map-card">
            <div class="map-guard">
                <div id="map"></div>
                <div class="map-overlay" aria-hidden="true"></div>
            </div>
                    <!-- Controls -->
        <div class="controls">
            <h3 style="margin: 0 0 15px 0; color: #00FF00;">‚öôÔ∏è TRACKING CONTROLS</h3>
            <div class="control-group">
                <label>Filter by Type:</label>
                <select id="typeFilter">
                    <option value="">All Aircraft</option>
                    <option value="commercial">Commercial</option>
                    <option value="military">Military</option>
                    <option value="general">General Aviation</option>
                    <option value="cargo">Cargo</option>
                </select>
            </div>
            <div class="control-group">
                <label>Min Altitude (ft):</label>
                <input type="number" id="minAltitude" value="0" min="0" step="1000">
            </div>
            <div class="control-group">
                <label>Auto-Refresh (sec):</label>
                <input type="number" id="refreshInterval" value="5" min="1" max="60" step="1">
            </div>
            <button class="btn btn-primary" style="width: 100%; margin-top: 10px;" onclick="toggleTracking()">
                ‚ñ∂ Start Tracking
            </button>
            </div>
            </div>
        </div>
        <!-- Aircraft List -->
        <div class="adsb-container">
            <div class="aircraft-details">
                <h3>Aircraft Details</h3>
                <div id="selectedAircraft" style="color: #AAA; text-align: center; padding: 20px;">
                    Select aircraft on map or from list
                </div>
            </div>
            <div class="aircraft-list">
                <h4 style="margin: 0 0 10px 0; color: #00FF00; text-transform: uppercase; font-size: 11px;">
                    Tracked Aircraft
                </h4>
                <div id="aircraftListContainer">
                    <div style="color: #AAA; text-align: center; padding: 20px;">
                        Loading aircraft...
                    </div>
                </div>
            </div>
        </div>
        <section class="panel">
            <h2>üìª VHF/SDR FREQUENCY CONTROL</h2>
            <p style="color: #AAA; margin: 0;">SDR Spectrum Monitoring & RF Transciever Tools</p>
        </section>
        <div class="sdr-container">
            <!-- Frequency Control Panel -->
            <div class="frequency-panel">
                <h3 style="margin: 0 0 15px 0; color: #2196F3;">RECEIVER CONTROL</h3>
                <!-- Frequency Display -->
                <div class="frequency-display">
                    <div class="frequency-value" id="frequencyDisplay">146.520</div>
                    <div class="frequency-unit">MHz</div>
                </div>
                <!-- Quick Frequency Input -->
                <div class="control-group">
                    <label class="control-label">Set Frequency</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" class="frequency-input" id="frequencyInput" value="146.520" 
                               placeholder="Enter frequency" style="flex: 1;">
                        <button class="btn btn-primary" onclick="setFrequency()" style="padding: 10px 20px;">
                            SET
                        </button>
                    </div>
                </div>
                <!-- Frequency Adjustment Buttons -->
                <div class="control-group">
                    <label class="control-label">Fine Tune</label>
                    <div class="frequency-buttons">
                        <button class="freq-btn" onclick="adjustFrequency(-1)">-1 MHz</button>
                        <button class="freq-btn" onclick="adjustFrequency(-0.1)">-0.1 MHz</button>
                        <button class="freq-btn" onclick="adjustFrequency(0.1)">+0.1 MHz</button>
                        <button class="freq-btn" onclick="adjustFrequency(-0.01)">-10 kHz</button>
                        <button class="freq-btn" onclick="adjustFrequency(0.01)">+10 kHz</button>
                        <button class="freq-btn" onclick="adjustFrequency(1)">+1 MHz</button>
                    </div>
                </div>
                <!-- Mode Selection -->
                <div class="control-group">
                    <label class="control-label">Modulation</label>
                    <div class="mode-selector">
                        <button class="mode-btn active" onclick="setMode(this, 'FM')">FM</button>
                        <button class="mode-btn" onclick="setMode(this, 'AM')">AM</button>
                        <button class="mode-btn" onclick="setMode(this, 'SSB')">SSB</button>
                        <button class="mode-btn" onclick="setMode(this, 'CW')">CW</button>
                    </div>
                </div>
                <!-- Presets -->
                <div class="control-group">
                    <label class="control-label">Saved Frequencies</label>
                    <div class="preset-buttons">
                        <button class="preset-btn" onclick="loadFrequency(146.52)">2M Simplex</button>
                        <button class="preset-btn" onclick="loadFrequency(462.5625)">GMRS 462</button>
                        <button class="preset-btn" onclick="loadFrequency(144.2)">2M Beacon</button>
                        <button class="preset-btn" onclick="loadFrequency(121.5)">Emergency</button>
                    </div>
                </div>
            </div>
            <!-- Spectrum Display -->
            <div>
                <!-- Signal Strength Meter -->
                <div class="spectrum-display">
                    <h3 style="margin: 0 0 15px 0; color: #2196F3;">SIGNAL ANALYSIS</h3>
                    
                    <div class="signal-meter">
                        <div class="meter-label">S-Meter (Signal Strength)</div>
                        <div class="meter-bar">
                            <div class="meter-fill" id="sMeter" style="width: 65%;">S 8</div>
                        </div>
                    </div>
                    <!-- Spectrum Canvas -->
                    <div class="meter-label">Frequency Spectrum</div>
                    <canvas id="spectrumCanvas" class="spectrum-canvas"></canvas>
                    <!-- Signal Stats -->
                    <table class="info-table">
                        <tr>
                            <td>Signal Strength</td>
                            <td id="signalStrength">-65 dBm</td>
                        </tr>
                        <tr>
                            <td>Noise Level</td>
                            <td id="noiseLevel">-90 dBm</td>
                        </tr>
                        <tr>
                            <td>SNR</td>
                            <td id="snr">25 dB</td>
                        </tr>
                        <tr>
                            <td>Modulation</td>
                            <td id="modulation">FM</td>
                        </tr>
                        <tr>
                            <td>Bandwidth</td>
                            <td id="bandwidth">12.5 kHz</td>
                        </tr>
                    </table>
                </div>
                <!-- Receiver Info -->
                <div class="spectrum-display">
                    <h3 style="margin: 0 0 15px 0; color: #2196F3;">RECEIVER STATUS</h3>
                    <table class="info-table">
                        <tr>
                            <td>Device</td>
                            <td>RTL-SDR (Generic)</td>
                        </tr>
                        <tr>
                            <td>Tuner</td>
                            <td>Rafael Micro R820T</td>
                        </tr>
                        <tr>
                            <td>Gain</td>
                            <td id="gainValue">37 dB</td>
                        </tr>
                        <tr>
                            <td>Sample Rate</td>
                            <td>2.048 MSPS</td>
                        </tr>
                        <tr>
                            <td>Status</td>
                            <td style="color: #00FF00;">‚óè ACTIVE</td>
                        </tr>
                    </table>
                    <!-- Gain Control -->
                    <div style="margin-top: 20px;">
                        <label class="control-label">Gain Control</label>
                        <input type="range" min="0" max="50" value="37" id="gainControl" 
                               style="width: 100%; cursor: pointer;" onchange="adjustGain(this.value)">
                        <div style="color: #AAA; font-size: 11px; margin-top: 5px; text-align: center;">
                            <span id="gainDisplay">37 dB</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    <!-- SIGNAL TRIANGULATION / DIRECTION FINDING -->
<section class="panel" id="triangulation-section">
    <h2>üìê SIGNAL TRIANGULATION & ORIGIN ESTIMATION</h2>
    <p style="color:#AAA;margin:0;">
        Direction-of-arrival analysis, multi-receiver bearing correlation, and estimated emitter location
    </p>
</section>

<div class="triangulation-grid">
    <!-- Compass / Bearing Visualization -->
    <div class="tri-card">
        <h3>BEARING / CARDINAL ORIENTATION</h3>
        <canvas id="bearingCompass" width="300" height="300"></canvas>

        <div class="bearing-readout">
            <div><span>Primary Bearing:</span> <strong id="primaryBearing">072¬∞ (ENE)</strong></div>
            <div><span>Confidence:</span> <strong id="bearingConfidence">¬±6¬∞</strong></div>
            <div><span>Signal Class:</span> <strong>VHF FM</strong></div>
        </div>
    </div>

    <!-- Receiver Bearings -->
    <div class="tri-card">
        <h3>RECEIVER BEARINGS</h3>
        <table class="info-table">
            <tr>
                <th>Receiver</th>
                <th>Bearing</th>
                <th>RSSI</th>
                <th>Status</th>
            </tr>
            <tr>
                <td>ADS-B Node</td>
                <td>068¬∞</td>
                <td>-61 dBm</td>
                <td style="color:#00FF00;">‚óè LOCK</td>
            </tr>
            <tr>
                <td>Tx/Rx Node</td>
                <td>081¬∞</td>
                <td>-67 dBm</td>
                <td style="color:#FFB300;">‚óè DEGRADED</td>
            </tr>
            <tr>
                <td>Mesh Node</td>
                <td>074¬∞</td>
                <td>-64 dBm</td>
                <td style="color:#00FF00;">‚óè LOCK</td>
            </tr>
        </table>
    </div>
    <!-- Triangulation Map -->
    <div class="tri-card tri-map-card">
        <h3>ESTIMATED SIGNAL ORIGIN</h3>
        <div class="map-guard tri">
            <div id="triangulationMap"></div>
            <div class="map-overlay" aria-hidden="true"></div>
        </div>
        <div class="tri-meta">
            <div><span>Estimated Error Radius:</span> <strong>¬±420 m</strong></div>
            <div><span>Solution Quality:</span> <strong style="color:#00FF00;">HIGH</strong></div>
            <div><span>Last Update:</span> <strong id="triUpdate">0.0s ago</strong></div>
        </div>
    </div>
</div>
    </main>
<!-- SIGNALS TRIANGULATION VISUALS -->
<script>
let triMap;
let emitterMarker;
let bearingLines = [];
function initTriangulationMap() {
    const mapEl = document.getElementById('triangulationMap');
    if (!mapEl) {
        console.error('Triangulation map container not found');
        return;
    }
    triMap = L.map(mapEl, {
        zoomControl: false,
        attributionControl: false
    }).setView([37.78, -122.42], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
    }).addTo(triMap);
    const receivers = [
        { name: 'ADS-B', lat: 37.80, lon: -122.45, bearing: 68 },
        { name: 'Tx/Rx', lat: 37.72, lon: -122.48, bearing: 81 },
        { name: 'Mesh',  lat: 37.75, lon: -122.38, bearing: 74 }
    ];
    receivers.forEach(r => {
        L.circleMarker([r.lat, r.lon], {
            radius: 6,
            color: '#00FF00',
            fillOpacity: 1
        }).addTo(triMap)
          .bindTooltip(r.name);
        drawBearing(r.lat, r.lon, r.bearing);
    });
    emitterMarker = L.circleMarker([37.77, -122.41], {
        radius: 8,
        color: '#FF1744',
        fillOpacity: 0.85
    }).addTo(triMap)
      .bindPopup('Estimated Signal Origin');
    setTimeout(() => triMap.invalidateSize(), 200);
}
function drawBearing(lat, lon, bearing) {
    const distance = 0.35;
    const rad = bearing * Math.PI / 180;
    const endLat = lat + distance * Math.cos(rad);
    const endLon = lon + distance * Math.sin(rad);
    const line = L.polyline(
        [[lat, lon], [endLat, endLon]],
        {
            color: '#FFB300',
            weight: 2,
            dashArray: '6,6'
        }
    ).addTo(triMap);
    bearingLines.push(line);
}
/* === COMPASS === */
function drawCompass(bearing) {
    const canvas = document.getElementById('bearingCompass');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const c = canvas.width / 2;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.strokeStyle = '#00FF00';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(c, c, c - 10, 0, Math.PI * 2);
    ctx.stroke();
    ctx.fillStyle = '#00FF00';
    ctx.font = '12px monospace';
    ctx.textAlign = 'center';
    ctx.fillText('N', c, 16);
    ctx.fillText('S', c, canvas.height - 6);
    ctx.fillText('E', canvas.width - 10, c + 4);
    ctx.fillText('W', 10, c + 4);
    const rad = (bearing - 90) * Math.PI / 180;
    ctx.strokeStyle = '#FF1744';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(c, c);
    ctx.lineTo(
        c + Math.cos(rad) * (c - 20),
        c + Math.sin(rad) * (c - 20)
    );
    ctx.stroke();
}
function updateTriangulationDemo() {
    const bearing = 70 + Math.random() * 10;
    document.getElementById('primaryBearing').textContent =
        `${bearing.toFixed(0)}¬∞`;
    drawCompass(bearing);
}
document.addEventListener('DOMContentLoaded', () => {
    initTriangulationMap();
    drawCompass(74);
    setInterval(updateTriangulationDemo, 4000);
});
</script>
<!--ADS-B / UAT Map Logic-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        let map;
        let aircraft = [];
        let markers = {};
        let selectedAircraftId = null;
        let trackingEnabled = false;
        let refreshInterval = 5;
        // Initialize map
        function initMap() {
            map = L.map('map').setView([37.7749, -122.4194], 8);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
        }
        // Load aircraft data
        async function loadAircraft() {
            try {
                const response = await fetch('/api/nodes/isr/adsb/aircraft');
                const data = await response.json();
                aircraft = data.aircraft || [];
                updateAircraftDisplay();
                updateStats();
                updateMap();
                updateAircraftList();
            } catch (error) {
                console.error('Error loading aircraft:', error);
            }
        }
        // Update aircraft display on map
        function updateMap() {
            // Clear old markers
            for (const id in markers) {
                map.removeLayer(markers[id]);
            }
            markers = {};
            // Add new markers
            aircraft.forEach(ac => {
                if (ac.latitude && ac.longitude) {
                    const icon = L.divIcon({
                        html: `<div style="
                            background: #00FF00;
                            color: #000;
                            padding: 4px 8px;
                            border-radius: 3px;
                            font-size: 11px;
                            font-weight: bold;
                            border: 2px solid #00FF00;
                            box-shadow: 0 0 10px rgba(0,255,0,0.5);
                        ">${ac.callsign || ac.icao}</div>`,
                        className: 'aircraft-marker',
                        iconSize: [80, 25],
                        iconAnchor: [40, 12]
                    });
                    const marker = L.marker([ac.latitude, ac.longitude], { icon })
                        .bindPopup(`
                            <strong>${ac.callsign || 'Unknown'}</strong><br>
                            ICAO: ${ac.icao}<br>
                            Alt: ${ac.altitude} ft<br>
                            Speed: ${ac.speed} kts
                        `)
                        .addTo(map)
                        .on('click', () => selectAircraft(ac));
                    
                    markers[ac.icao] = marker;
                }
            });
        }
        // Update aircraft list
        function updateAircraftList() {
            const container = document.getElementById('aircraftListContainer');
            if (aircraft.length === 0) {
                container.innerHTML = '<div style="color: #AAA; text-align: center; padding: 20px;">No aircraft detected</div>';
                return;
            }
            container.innerHTML = aircraft.map(ac => `
                <div class="aircraft-item ${ac.icao === selectedAircraftId ? 'selected' : ''}" 
                     onclick="selectAircraft(${JSON.stringify(ac).replace(/"/g, '&quot;')})">
                    <div class="callsign">${ac.callsign || 'UNKNOWN'}</div>
                    <div class="icao">${ac.icao}</div>
                    <div class="stats">
                        <strong>${ac.altitude}</strong> ft<br>
                        <strong>${ac.speed}</strong> kts<br>
                        ${ac.heading ? '<strong>Hdg:</strong> ' + ac.heading + '¬∞<br>' : ''}
                    </div>
                </div>
            `).join('');
        }
        // Select aircraft and show details
        function selectAircraft(ac) {
            selectedAircraftId = ac.icao;
            const details = document.getElementById('selectedAircraft');
            details.innerHTML = `
                <div style="text-align: left;">
                    <h4 style="color: #00FF00; margin: 0 0 10px 0;">${ac.callsign || 'UNKNOWN'}</h4>
                    <table style="width: 100%; font-size: 12px; color: #AAA;">
                        <tr>
                            <td style="padding: 3px 0;"><strong>ICAO:</strong></td>
                            <td style="color: #00FF00;">${ac.icao}</td>
                        </tr>
                        <tr>
                            <td style="padding: 3px 0;"><strong>Altitude:</strong></td>
                            <td style="color: #00FF00;">${ac.altitude} ft</td>
                        </tr>
                        <tr>
                            <td style="padding: 3px 0;"><strong>Speed:</strong></td>
                            <td style="color: #00FF00;">${ac.speed} kts</td>
                        </tr>
                        <tr>
                            <td style="padding: 3px 0;"><strong>Heading:</strong></td>
                            <td style="color: #00FF00;">${ac.heading || 'N/A'}¬∞</td>
                        </tr>
                        <tr>
                            <td style="padding: 3px 0;"><strong>Position:</strong></td>
                            <td style="color: #00FF00;">${ac.latitude?.toFixed(4)}, ${ac.longitude?.toFixed(4)}</td>
                        </tr>
                    </table>
                </div>
            `;
            updateAircraftList();
        }
        // Update statistics
        function updateStats() {
            document.getElementById('aircraftCount').textContent = aircraft.length;
            document.getElementById('messageRate').textContent = Math.floor(Math.random() * 100 + 50);
            if (aircraft.length > 0) {
                const maxAlt = Math.max(...aircraft.map(a => a.altitude || 0));
                const avgSpeed = Math.round(aircraft.reduce((sum, a) => sum + (a.speed || 0), 0) / aircraft.length);
                document.getElementById('maxAltitude').textContent = `${maxAlt} ft`;
                document.getElementById('avgSpeed').textContent = `${avgSpeed} kts`;
            }
        }
        // Update display
        function updateAircraftDisplay() {
            // Apply filters
            const typeFilter = document.getElementById('typeFilter').value;
            const minAlt = parseInt(document.getElementById('minAltitude').value) || 0;
            if (typeFilter) {
                // Filter logic would go here
            }
        }
        // Toggle tracking
        function toggleTracking() {
            trackingEnabled = !trackingEnabled;
            const btn = event.target;
            btn.textContent = trackingEnabled ? '‚èπ Stop Tracking' : '‚ñ∂ Start Tracking';
            btn.className = trackingEnabled ? 'btn btn-danger' : 'btn btn-primary';
            if (trackingEnabled) {
                loadAircraft();
                startAutoRefresh();
            }
        }
        // Auto-refresh
        function startAutoRefresh() {
            refreshInterval = parseInt(document.getElementById('refreshInterval').value) || 5;
            if (trackingEnabled) {
                loadAircraft();
                setTimeout(startAutoRefresh, refreshInterval * 1000);
            }
        }
        // Initialize
        initMap();
        loadAircraft();
    </script>
    <!--Node Actions Modal-->
    <script>
const modal = document.getElementById('node-modal');
const modalNodeName = document.getElementById('modal-node-name');
let currentNode = '';
function openNodeModal(nodeName){
  currentNode = nodeName;
  modalNodeName.textContent = nodeName + " Node Actions";
  modal.style.display = "block";
}
function closeNodeModal(){
  modal.style.display = "none";
}
function rebootNode(){
  alert(currentNode + " node reboot triggered!");
}
function runDiagnostics(){
  alert("Running diagnostics on " + currentNode + " node.");
}
window.onclick = function(event){
  if(event.target == modal){ closeNodeModal(); }
}
// Toggle alerts
document.querySelectorAll('.alert-icon').forEach(icon => {
  icon.addEventListener('click', e => {
    e.preventDefault();
    icon.parentElement.querySelector('.alert-panel').classList.toggle('visible');
  });
});
</script>
<!--Toggle Sidebar Logic-->
<script>
function toggleSidebar() {
    const sidebar = document.getElementById('quick-sidebar');
    sidebar.classList.toggle('expanded');
    sidebar.classList.toggle('collapsed');
}
</script>
<!--Collapse Sticky Top Nav On Scroll-->
<script>
document.addEventListener('DOMContentLoaded', () => {
    const navbar = document.querySelector('.navbar');
    if (!navbar) return;
    let isCollapsed = false;
    const COLLAPSE_THRESHOLD = 10;
    function checkCollapse() {
        const scrollTop = window.scrollY || document.documentElement.scrollTop;
        const shouldCollapse = scrollTop > COLLAPSE_THRESHOLD;
        if (shouldCollapse !== isCollapsed) {
            navbar.classList.toggle('collapsed', shouldCollapse);
            isCollapsed = shouldCollapse;
        }
    }
    window.addEventListener('scroll', checkCollapse);
    checkCollapse(); // initial check in case page is already scrolled
});
</script>
<!--Prevent Accidential Map Interactions-->
<script>
(() => {
    const mapGuard = document.querySelector('.map-guard');
    const overlay  = document.querySelector('.map-overlay');
    if (!mapGuard || !overlay) return;
    let blockTimer = null;
    mapGuard.addEventListener('mouseenter', () => {
        overlay.classList.add('active');
        blockTimer = setTimeout(() => {
            overlay.classList.remove('active');
            blockTimer = null;
        }, 900);
    });
    mapGuard.addEventListener('mouseleave', () => {
        overlay.classList.remove('active');
        if (blockTimer) {
            clearTimeout(blockTimer);
            blockTimer = null;
        }
    });
})();
</script>
</body>
</html>
