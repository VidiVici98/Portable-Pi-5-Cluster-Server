# Fail2Ban Configuration
# Purpose: Protect against brute force attacks
# Location: /etc/fail2ban/jail.local
# Apply with: sudo systemctl restart fail2ban

[DEFAULT]
# === General Settings ===
bantime = 3600                    # Ban for 1 hour
findtime = 600                    # Within 10 minutes
maxretry = 3                      # Ban after 3 failures
destemail = admin@example.com     # Email for alerts
sendername = Fail2Ban
mta = sendmail                    # Mail transport agent

# === Network Configuration ===
# Whitelist trusted IPs (don't ban these)
ignoreip = 127.0.0.1/8 ::1
            10.0.0.0/8
            192.168.0.0/16

# === Email Actions (Optional) ===
# action = %(action_mwl)s        # Ban + send email with logs
action = %(action)s               # Just ban (no email)

# === Logging ===
logpath = %(syslog_authpriv)s     # SSH authentication logs
backendb = auto

# ==============================================================================
# SSH Jail - Protect against brute force
# ==============================================================================

[sshd]
enabled = true
port = ssh                        # Or specify: 22
logpath = /var/log/auth.log       # Path to auth logs
maxretry = 3                      # Ban after 3 failures
findtime = 600                    # Within 10 minutes
bantime = 3600                    # Ban for 1 hour (3600 seconds)

# Pattern to match failed attempts
# Defaults are good - don't change unless needed
# filter = sshd

# ==============================================================================
# SSHD Recidivism - Ban repeat offenders longer
# ==============================================================================

[sshd-recidivism]
enabled = true
filter = sshd
port = ssh
logpath = /var/log/auth.log
action = %(action_mwl)s           # Ban + email
bantime = 604800                  # Ban for 1 week (7 days)
findtime = 86400                  # Within 1 day
maxretry = 1                      # Ban after 1 additional failure

# ==============================================================================
# TFTP Jail - Protect against TFTP attacks (boot node only)
# ==============================================================================

[tftp]
enabled = false                   # Enable if using TFTP
port = tftp
logpath = /var/log/syslog
maxretry = 10
findtime = 600
bantime = 3600

# ==============================================================================
# Custom Jail - Monitor custom application logs
# ==============================================================================

# Example: Monitor dnsmasq for attacks
[dnsmasq]
enabled = false
port = 53
protocol = udp
logpath = /var/log/syslog
maxretry = 100
findtime = 600

# ==============================================================================
# Post-Deployment Commands
# ==============================================================================

# Check Fail2Ban status:
# sudo fail2ban-client status

# Check SSH jail specifically:
# sudo fail2ban-client status sshd

# View banned IPs:
# sudo iptables -L | grep -i fail2ban

# Unban specific IP:
# sudo fail2ban-client set sshd unbanip 192.168.1.100

# View logs:
# sudo grep -i fail2ban /var/log/syslog | tail -20

# Test fail2ban with fake failures (optional):
# for i in {1..5}; do ssh invaliduser@localhost; done

# ==============================================================================
# Security Checklist
# ==============================================================================

# ✅ SSH jail enabled
# ✅ maxretry = 3 (3 failures before ban)
# ✅ bantime = 3600 (1 hour minimum)
# ✅ ignoreip includes trusted networks
# ✅ Email notifications configured (optional)
# ✅ Fail2Ban service enabled
# ✅ Tested failed authentication 3x, verified ban works

# ==============================================================================
# Monitoring
# ==============================================================================

# Regular checks:
# - Daily: Review /var/log/auth.log for patterns
# - Weekly: Check fail2ban-client status
# - Monthly: Review IP reputation of banned IPs
# - Quarterly: Review fail2ban rules alignment with threats

# Alert on excessive bans (potential attack):
# sudo tail -f /var/log/fail2ban.log | grep Ban

# Ensure legitimate users can still access:
# ssh -v pi@node-hostname  # Should succeed
