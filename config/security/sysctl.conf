# Kernel Hardening Configuration
# Purpose: Security tuning at kernel level
# Location: /etc/sysctl.d/99-hardening.conf
# Apply with: sudo sysctl -p /etc/sysctl.d/99-hardening.conf

# ==============================================================================
# Network Security - Prevent common network-based attacks
# ==============================================================================

# Disable IP forwarding (unless this is a router)
net.ipv4.ip_forward = 0
net.ipv6.conf.all.forwarding = 0

# Disable source packet routing
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.icmp_echo_ignore_all = 0

# Disable ICMP redirects
net.ipv6.conf.all.accept_redirects = 0
net.ipv6.conf.default.accept_redirects = 0

# Enable bad error message protection
net.ipv4.icmp_ignore_bogus_error_responses = 1

# Enable reverse path filtering (prevent spoofing)
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1

# Log suspicious packets
net.ipv4.conf.all.log_martians = 1
net.ipv4.conf.default.log_martians = 1

# Increase TCP backlog
net.core.netdev_max_backlog = 5000
net.ipv4.tcp_max_syn_backlog = 5000

# Disable ICMP Echo
# Uncomment to hide from ping:
# net.ipv4.icmp_echo_ignore_all = 1

# ==============================================================================
# SYN Flood Protection
# ==============================================================================

net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_syn_retries = 2
net.ipv4.tcp_synack_retries = 2
net.ipv4.tcp_max_tw_buckets = 2000000
net.ipv4.tcp_fin_timeout = 10

# ==============================================================================
# Core Dumps - Prevent information leakage
# ==============================================================================

kernel.dmesg_restrict = 1
fs.suid_dumpable = 0
kernel.printk = 3 3 3 3

# ==============================================================================
# Process Accounting and Audit
# ==============================================================================

# Restrict access to kernel logs
kernel.sysrq = 0

# Restrict ptrace scope (prevent parent process inspection)
kernel.yama.ptrace_scope = 2

# ==============================================================================
# Memory and Randomization
# ==============================================================================

# Enable Address Space Layout Randomization (ASLR)
kernel.randomize_va_space = 2

# Restrict access to kernel modules
kernel.modules_disabled = 1

# ==============================================================================
# IPC Security
# ==============================================================================

# Restrict IPC namespace access
kernel.msgmax = 65536
kernel.shmmax = 68719476736
kernel.shmall = 4194304

# ==============================================================================
# File System Security
# ==============================================================================

# Restrict dmesg access to root only
kernel.dmesg_restrict = 1

# Restrict access to /proc/sys/kernel
kernel.kptr_restrict = 2
kernel.perf_event_paranoid = 3

# ==============================================================================
# Panic and Reboot Settings
# ==============================================================================

# Restart after 10 seconds of kernel panic (for cluster resilience)
kernel.panic = 10
kernel.panic_on_oops = 1

# ==============================================================================
# Post-Deployment Verification
# ==============================================================================

# Apply settings:
# sudo sysctl -p /etc/sysctl.d/99-hardening.conf

# Verify settings applied:
# sysctl -a | grep -E "net.ipv4|kernel.panic|kernel.randomize"

# Check specific setting:
# sysctl net.ipv4.ip_forward

# Verify current value immediately (without reboot):
# cat /proc/sys/net/ipv4/ip_forward

# ==============================================================================
# Common Issues
# ==============================================================================

# "sysctl: permission denied" - Run with sudo
# "invalid argument" - Parameter not supported on this kernel
# "read-only file system" - Usually transient, wait and retry

# ==============================================================================
# Security Notes
# ==============================================================================

# ASLR (kernel.randomize_va_space = 2)
# - Randomizes memory layout on each execution
# - Prevents predictable attacks
# - Minimal performance impact

# Panic on Oops (kernel.panic_on_oops = 1)
# - Kernel panics if suspicious condition detected
# - Forces reboot after kernel.panic seconds
# - Good for cluster resilience

# rp_filter (net.ipv4.conf.all.rp_filter = 1)
# - Strict reverse path filtering
# - Prevents IP spoofing
# - Important for security

# ==============================================================================
# Monitoring and Audit
# ==============================================================================

# View all hardening settings:
# sysctl -a | grep -E "^(kernel|net)"

# Monitor for sysctl violations:
# auditctl -w /etc/sysctl.conf -p wa -k sysctl_changes

# Check kernel panic logs:
# journalctl -p warning -S "1 hour ago" | grep -i panic

# ==============================================================================
# Security Checklist
# ==============================================================================

# ✅ IP forwarding disabled (0)
# ✅ Source routing disabled (0)
# ✅ SYN cookies enabled (1)
# ✅ ASLR enabled (2)
# ✅ Core dumps restricted (0)
# ✅ ptrace scope restricted (2)
# ✅ dmesg restricted (1)
# ✅ All settings applied without errors
